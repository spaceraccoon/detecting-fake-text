!function(t){function e(e){for(var s,a,r=e[0],l=e[1],c=e[2],h=0,d=[];h<r.length;h++)a=r[h],n[a]&&d.push(n[a][0]),n[a]=0;for(s in l)Object.prototype.hasOwnProperty.call(l,s)&&(t[s]=l[s]);for(p&&p(e);d.length;)d.shift()();return o.push.apply(o,c||[]),i()}function i(){for(var t,e=0;e<o.length;e++){for(var i=o[e],s=!0,r=1;r<i.length;r++){var l=i[r];0!==n[l]&&(s=!1)}s&&(o.splice(e--,1),t=a(a.s=i[0]))}return t}var s={},n={0:0},o=[];function a(e){if(s[e])return s[e].exports;var i=s[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=t,a.c=s,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)a.d(i,s,function(e){return t[e]}.bind(null,s));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="";var r=window.webpackJsonp=window.webpackJsonp||[],l=r.push.bind(r);r.push=e,r=r.slice();for(var c=0;c<r.length;c++)e(r[c]);var p=l;o.push([13,1]),i()}([,,,,,,,,function(t,e,i){},function(t,e,i){t.exports=i.p+"index.html"},function(t,e,i){var s={"./gpt-2-small_examples.json":11,"./gpt-3-davinci_examples.json":12};function n(t){var e=o(t);return i(e)}function o(t){var e=s[t];if(!(e+1)){var i=new Error("Cannot find module '"+t+"'");throw i.code="MODULE_NOT_FOUND",i}return e}n.keys=function(){return Object.keys(s)},n.resolve=o,t.exports=n,n.id=10},function(t){t.exports=[{file:"gpt2_small_top5_uncond.json",description:"machine: GPT-2 small top_k 5 temp 1"},{file:"gpt_2_small_top40_t0.7.json",description:"machine: GPT-2 small top_k 40 temp .7"},{file:"unicorn.json",description:"machine*: unicorn text (GPT2 large)"},{file:"NYTimes.json",description:"human: NYTimes article"},{file:"paper_gan.json",description:"human: academic text"},{file:"woodchuck.json",description:"human: woodchuck :)"}]},function(t){t.exports=[{file:"gpt2_small_top5_uncond.json",description:"machine: GPT-2 small top_k 5 temp 1"},{file:"gpt_2_small_top40_t0.7.json",description:"machine: GPT-2 small top_k 40 temp .7"},{file:"unicorn.json",description:"machine*: unicorn text (GPT2 large)"},{file:"NYTimes.json",description:"human: NYTimes article"},{file:"paper_gan.json",description:"human: academic text"},{file:"woodchuck.json",description:"human: woodchuck :)"}]},function(t,e,i){"use strict";i.r(e);var s=i(1);i(14),i(8),i(9);class n{constructor(t){this.element=t,this.eventListeners=[]}bind(t,e){for(const i of t.split(" ")){this.eventListeners.push({eventName:i,eventFunction:e});const t=t=>e(t.detail,t);this.element.addEventListener(i,t,!1)}}getListeners(){return this.eventListeners}trigger(t,e){this.element.dispatchEvent(new CustomEvent(t,{detail:e}))}}class o{static basicURL(){const t=window.location.pathname.split("/").slice(0,-2).join("/");return window.location.origin+(t.length?t:"")}static get parameters(){const t=window.location.search.substring(1).split("&");console.log(t,"--- vars");const e={},i=t=>(t=>/^[0-9]+$/.test(t))(t)?Number.parseInt(t,10):(t=>/^[0-9]+\.[0-9]*$/.test(t))(t)?Number.parseFloat(t):t;return t.forEach(t=>{if(t.length>0){const s=t.split("="),n=decodeURIComponent(s[0]);let o=decodeURIComponent(s[1]);const a=o.startsWith("..");a&&(o=o.slice(2)),o.length<1?e[n]=a?[]:"":e[n]=a?o.split(",").map(t=>i(t)):i(o)}}),e}static urlString(t){const e=[];Object.keys(t).forEach(i=>{const s=t[i];if(void 0!==s){let t=s;Array.isArray(s)&&(t=".."+s.join(",")),e.push(encodeURI(i+"="+t))}});const i=window.location.pathname;let s=i.substring(i.lastIndexOf("/")+1);return e.length>0&&(s+="?"+e.join("&")),s}static updateURLParam(t,e,i=!0){const s=o.parameters;s[t]=e,o.updateUrl(s,i)}static updateUrl(t,e=!0){e?window.history.pushState(t,"",o.urlString(t)):window.history.replaceState(t,"",o.urlString(t))}}let a=0;class r{static simpleUId({prefix:t=""}){return t+(a+=1)}}function l(t){t=t.startsWith("Ġ")?t.slice(1):t.startsWith("Ċ")||t.startsWith("â")?" ":t;try{t=decodeURIComponent(escape(t))}catch(e){console.log(t,"-- token is hard")}return t}const c=t=>t.replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u2013\u2014]/g,"-");class p{static translate({x:t,y:e}){return"translate("+t+","+e+")"}static group(t,e,i={x:0,y:0}){return t.append("g").attrs({class:e,transform:p.translate(i)})}}class h{constructor(t,e){this.id=r.simpleUId({}),this.parent=t,this.eventHandler=e||new n(this.parent.node()),this._visibility={hidden:!1}}superInitHTML(t={}){Object.keys(t).forEach(e=>this.options[e]=t[e]),this.base=this.parent.append("div").classed(this.css_name,!0)}superInitSVG(t={},e=["bg","main","fg"]){Object.keys(t).forEach(e=>this.options[e]=t[e]),this.layers={},this.base=p.group(this.parent,this.css_name+" ID"+this.id,this.options.pos),e&&e.forEach(t=>{this.layers[t]=p.group(this.base,t)})}update(t){this.data=t,this._visibility.hidden||(this.renderData=this._wrangle(t),this._render(this.renderData))}updateOptions(t,e=!1){Object.keys(t).forEach(e=>this.options[e]=t[e]),e&&this._render(this.renderData)}setHideElement(t){this._visibility.hideElement=t}hideView(){if(!this._visibility.hidden){(this._visibility.hideElement||this.parent).transition().styles({opacity:0,"pointer-events":"none"}).style("display","none"),this._visibility.hidden=!0}}unhideView(){if(this._visibility.hidden){(this._visibility.hideElement||this.parent).transition().styles({opacity:1,"pointer-events":null,display:null}),this._visibility.hidden=!1}}destroy(){this.base.remove()}}var d;h.events={noEvent:"VComponent_noEvent"},function(t){t[t.topk=0]="topk",t[t.diff_p=1]="diff_p",t[t.fract_p=2]="fract_p"}(d||(d={}));class u extends h{constructor(t,e,i={}){super(t,e),this._current={maxValue:-1},this.css_name="LMF",this.options={gltrMode:d.topk,diffScale:s.k().exponent(.3).range(["#b4e876","#fff"]),fracScale:s.j().range(["#fff","#b4e876"]),topkScale:s.l().domain([10,100,1e3]).range(["#ADFF80","#FFEA80","#FF9280","#E5B0FF"])},this.superInitHTML(i),this._init()}_init(){}_render(t=this.renderData){if(!t)return;const e=this.options,i=(this._current,t.bpe_strings.slice(1)),s=t.real_topk,n=i.map((e,i)=>({token:e,top:s[i][0],prop:s[i][1],others:t.pred_topk[i]}));n.forEach(t=>{console.log("-hen--",t.token,t.token.charCodeAt(0))}),this.base.selectAll(".token").data(n,(t,e)=>t.token+"__"+e).join("div").attr("class",t=>`token ${t.token.startsWith("Ġ")?"spaceLeft":""} ${t.token.startsWith("Ċ")?"newLine":""}`).style("background-color",t=>{if(e.gltrMode===d.topk)return e.topkScale(t.top);if(e.gltrMode===d.diff_p){const i=t.others[0][1]-t.prop;return console.log(i,e.diffScale(i),e.diffScale.domain(),"--- diff, cur.diffScale(diff), cur.diffScale.domain()"),e.diffScale(i)}if(e.gltrMode===d.fract_p){const i=t.prop/t.others[0][1];return e.fracScale(i)}}).text(t=>l(t.token)).on("mousemove",t=>this.eventHandler.trigger(u.events.tokenHovered,{hovered:!0,d:t})).on("mouseleave",t=>this.eventHandler.trigger(u.events.tokenHovered,{hovered:!1,d:t}))}_wrangle(t){const e=t.pred_topk.map(t=>t[0][1]);return this._current.maxValue=s.g(e),this.options.diffScale.domain([0,this._current.maxValue]),t}updateThresholdValues(t){this.options.topkScale.domain(t),this._render()}get colorStats(){const t={};return this.options.topkScale.range().forEach(e=>t[e]=0),this.data.real_topk.map(t=>t[0]).forEach(e=>{const i=this.options.topkScale(e);t[i]+=1}),{colors:this.options.topkScale.range(),values:this.options.topkScale.range().map(e=>t[e])}}}u.events={tokenHovered:"lmf-view-token-hovered"};class m extends h{constructor(t,e,i={}){super(t,e),this._current={},this.css_name="HistogramX",this.options={width:200,height:150,margin_top:10,numberFormat:s.d(".3")},this.superInitSVG(i,["bg","main","box","fg"]),this._init()}_init(){const t=this.options;this.parent.attrs({width:t.width,height:t.height}),this.layers.bg.append("g").attr("class","y-axis").attr("transform",`translate(${t.width-33},0)`),this.layers.bg.append("g").attr("class","x-axis").attr("transform",`translate(0,${t.height-21})`),this.highlightLabel=this.layers.fg.append("text").attr("class","highlightLabel sizeLabel")}_render(t){const e=this.options,i=t.data.map(t=>+t).sort((t,e)=>t-e),n=t.extent||s.c(i);let o=s.j().domain(n).range([5,e.width-35]);const a=t.no_bins||Math.min(s.o(i,n[0],n[1]),20),r=(o=o.nice(a)).ticks(a);r[r.length-1]==n[1]&&r.pop();const l=s.e().domain(o.domain()).thresholds(r)(i);console.log(l,"-- histo");const c=s.j().domain([0,s.g(l,t=>t.length)]).nice().range([e.height-35,e.margin_top]),p=t=>t>5?t-1:.9*t;this.layers.main.selectAll(".bar").data(l).join("rect").attr("class","bar").attrs({x:t=>o(t.x0),y:t=>c(t.length),width:t=>p(o(t.x1)-o(t.x0)),height:t=>e.height-35-c(t.length)}).on("mouseenter",t=>{const e=o(t.x0)+.5*p(o(t.x1)-o(t.x0)),i=c(t.length)-2;this.highlightLabel.attr("transform",`translate(${e},${i})`).style("visibility",null).text(()=>t.length)}).on("mouseleave",()=>this.highlightLabel.style("visibility","hidden"));this.layers.bg.select(".y-axis").call(s.b(c).tickFormat(e.numberFormat)),this.layers.bg.select(".x-axis").call(s.a(o).tickFormat(e.numberFormat).ticks(r.length));const h=s.i(i,.5),d=[.25,.75].map(t=>s.i(i,t));this.layers.box.selectAll(".quantiles").data([d.map(t=>o(t))]).join("rect").attr("class","quantiles").attrs({x:t=>t[0],width:t=>t[1]-t[0],y:e.height-33,height:10});this.layers.box.selectAll(".median").data([h]).join("g").attr("class","median").attr("transform",t=>`translate(${o(t)},${e.height-28})`).html(t=>'<line x1="-3" y1="0" x2="3" y2="0"/><line x1="0" y1="-3" x2="0" y2="3"/>'+`<text x="6">${e.numberFormat(t)}</text>`)}_wrangle(t){return t}}const f={sidebar:{width:400,visible:!1},demo:!0,entropyThreshold:10,project_name:"gpt-3-davinci"},g={mode_topk:d.topk,mode_diff_p:d.diff_p,mode_frac_p:d.fract_p};window.onload=(()=>{const t=new n(s.m("body").node());o.parameters.nodemo&&(f.demo=!1);const e=s.m(".side_bar");e.style("width",`${f.sidebar.width}px`);const a=new class{constructor(t=null){this.baseURL=t,null==this.baseURL&&(this.baseURL=o.basicURL())}all_projects(){return s.f(this.baseURL+"/api/all_projects")}analyze(t,e,i=null){const n={project:t,text:c(e)};return i&&(n.bitmask=i),s.f(this.baseURL+"/api/analyze",{method:"POST",body:JSON.stringify(n),headers:{"Content-type":"application/json; charset=UTF-8"}})}}(o.parameters.api||""),r=new class{constructor(t,e){this.parent=t,this.eh=e,this._init()}_init(){this.predictions=this.parent.select(".predictions"),this.myDetail=this.parent.select(".myDetail")}set visility(t){1==t?this.parent.style("opacity",1):this.parent.style("opacity",0)}updateData(t){this.visility=!0;const e=t.others[0][1],i=s.j().domain([0,e]).range([0,60]),n=s.d(".3f");let[o,a]=s.h(s.m("body").node());o=o>window.innerWidth/2?o-200:o,this.parent.styles({top:a+30+"px",left:o+"px"}),this.predictions.selectAll(".row").data(t.others.slice(0,5)).join("div").attr("class","row").style("display","table-row").html(e=>{const s=t.token!=e[0]?"#333":"#933";return`${'<div style="display: table-cell; width:110px;padding-left:5px;">'+`<div style="display:inline-block;width: ${i(e[1])}px;background-color:${s};height: 10px;"></div>`+` <div style="display:inline-block;color: ${s};">${n(e[1])}</div>`+"</div>"} ${`<div style="display: table-cell;color: ${s}">${l(e[0])}</div>`}`}),this.myDetail.html(()=>{t.others[0][1],t.prop;const e=t.prop/t.others[0][1];return`${`<span style="color: #666">top_k pos:</span> <span style="color: #333">${t.top}</span>`} ${`<span style="color: #666666">prob:</span> <span style="color: #333">${n(t.prop)}</span>`} <br/>${`<span style="color: #666">frac(p):</span> <span style="color: #333">${n(e)}</span>`}`})}}(s.m("#major_tooltip"),t),p=s.m("#submit_text_btn"),d=s.m("#test_text"),y=s.n(".btn_mode"),b=new class extends h{constructor(t,e,i={}){super(t,e),this.options={width:200,height:150,margin_top:10,numberFormat:s.d(".3")},this.css_name="barchartX",this._current={},this.superInitSVG(i),this._init()}_init(){const t=this.options;this.parent.attrs({width:t.width,height:t.height}),this.layers.bg.append("g").attr("class","y-axis").attr("transform",`translate(${t.width-33},0)`),this.highlightLabel=this.layers.fg.append("text").attr("class","highlightLabel sizeLabel")}_wrangle(t){return t}_render(t){const e=this.options,i=s.j().domain([0,t.values.length]).range([5,e.width-35]),n=t.extent||[0,s.g(t.values)],o=s.j().domain(n).nice(10).range([e.height-35,e.margin_top]),a=(t=>t>5?t-1:.9*t)(i(1)-i(0)),r=t.values.map((e,i)=>({v:e,c:(e=>t.colors?t.colors[e%t.colors.length]:null)(i)}));this.layers.main.selectAll(".bar").data(r).join("rect").attr("class","bar").attrs({x:(t,e)=>i(e),y:t=>o(t.v),width:t=>a,height:t=>e.height-35-o(t.v)}).style("fill",t=>t.c).style("opacity",1).on("mouseenter",(t,e)=>{const s=i(e)+.5*a,n=o(t.v)-2;this.highlightLabel.attr("transform",`translate(${s},${n})`).style("visibility",null).text(()=>t.v)}).on("mouseleave",()=>this.highlightLabel.style("visibility","hidden")),this.layers.bg.select(".y-axis").call(s.b(o).tickFormat(e.numberFormat))}}(s.m("#stats_top_k"),t),_=new m(s.m("#stats_frac"),t),v=new m(s.m("#stats_entropy"),t),w=()=>[+s.m("#color1").property("value"),+s.m("#color2").property("value"),+s.m("#color3").property("value")],x=()=>{const t=y.filter(function(){return s.m(this).classed("selected")}).property("id");return g[t]},k=new u(s.m("#results"),t,{color_thresholds:w()}),j=()=>{s.m("#model_name").text(f.project_name),s.m("#loader").style("opacity",0),s.n(".main_frame").style("opacity",1)};if(f.demo){const t=i(10)("./"+f.project_name+"_examples.json"),e=t=>{$(t.api),d.property("value",t.api.request.text)};s.m(".demos").selectAll(".demoBtn").data(t).join("div").attr("class","demoBtn").html(t=>t.description).on("click",t=>{p.classed("inactive",!0),t.api?e(t):(s.n(".loadersmall").style("display",null),s.f("demo/"+t.file).then(i=>{t.api=i,e(t)}))}),j()}else a.all_projects().then(t=>{f.project_name=Object.keys(t)[0],s.n(".demo").remove(),j()});const S=()=>{const t=k.colorStats;b.update(t)},$=t=>{console.log(t,"--- data"),s.m("#all_result").style("opacity",1).style("display",null),s.n(".loadersmall").style("display","none"),k.update(t.result),S(),(t=>{const e=t.result.pred_topk.map(t=>{const e=t.slice(0,f.entropyThreshold).map(t=>t[1]),i=e.reduce((t,e)=>t+e);return-1*e.map(t=>t/i).map(t=>0==t?0:t*Math.log(t)).reduce((t,e)=>t+e,0)});v.update({data:e,no_bins:8})})(t);const e=t.result.real_topk.map((e,i)=>e[1]/t.result.pred_topk[i][0][1]);_.update({data:e,label:"frac",no_bins:10,extent:[0,1]}),p.classed("inactive",!1)};p.on("click",()=>{const t=d.property("value");s.n(".loadersmall").style("display",null),p.classed("inactive",!0),a.analyze(f.project_name,t).then($)}),y.on("click",function(){const t=this;y.classed("selected",function(){return this===t}),k.updateOptions({gltrMode:x()},!0)}),s.n(".colorThreshold").on("input",()=>{k.updateThresholdValues(w()),S()}),t.bind(u.events.tokenHovered,t=>{t.hovered?r.updateData(t.d):r.visility=!1}),s.m("body").on("touchstart",()=>{r.visility=!1});!function(){function t(t=window.innerWidth,e=window.innerHeight){s.n(".sidenav").style("height",e-53+"px");const i=f.sidebar,n=t-(i.visible?i.width:0);s.n(".main_frame").style("height",e-53+"px").style("width",n+"px")}s.m("#sidebar_btn").on("click",function(){const i=f.sidebar;i.visible=!i.visible,s.m(this).classed("on",i.visible),e.classed("hidden",!i.visible),e.style("right",i.visible?null:`-${f.sidebar.width}px`),t()}),window.onresize=(()=>{t(window.innerWidth,window.innerHeight)}),t(window.innerWidth,window.innerHeight)}()})}]);